<!DOCTYPE html>
<html>
    {{- partial "head.html" . -}}
    <body>
        {{- partial "header.html" . -}}
        <div id="content">
        {{- block "main" . }}{{- end }}
        </div>
        {{- partial "footer.html" . -}}
        <script src="/js/jquery-3.4.1.min.js"></script>
        <script src="/js/semantic.min.js"></script>
        <script>
        $('.ui.accordion').accordion();

        const headers = $('#post-content :header');
        const paragraph_link_html = '<i id="paragraph-link-icon" class="paragraph link icon" onclick="to_paragraph(this)"></i>';
        const toc_link_html = '<i id="toc-link-icon" class="list ul link icon" onclick="to_toc(this)"></i>';
        headers.popup({
            position: 'left center',
            distanceAway: 10,
            hoverable: true,
            exclusive: true,
            delay: {show: 0, hide: 250},
            html: ($('#toc').length <= 0 ? '' : toc_link_html) + paragraph_link_html,
            forcePosition: true,
            inline: true
        });

        function get_header(element) {
            return $(element).parent('.popup').prev().attr('id')
        }

        function to_paragraph(e) {
            const header = get_header(e);
                window.location = `#${header}`;
        }

        function to_toc() {
            if ($('#toc.accordion .title').hasClass('active'))
            {
                window.location = '#toc';
            }
            else
            {
                $('.ui.accordion#toc').accordion('open', 0);
                setTimeout(() => {
                    window.location = '#toc';
                }, 500);
            }
        }
        </script>

        <script src="/js/fuse.min.js"></script>
        <script>
            const fuse_options = {
                shouldSort: true,
                threshold: 0.6,
                location: 0,
                distance: 100,
                maxPatternLength: 32,
                minMatchCharLength: 1,
                keys: [
                    'title',
                    'series',
                    'categories'
                ]
            };
            
            var fuse = false;
            var fuse_promise = new Promise((resolve, reject) => {
                $.getJSON('/search/index.json', (result, status) => {
                    console.log(status);
                    console.log(result);
                    if (status === 'success') {
                        resolve(result);
                    }
                    else {
                        reject();
                    };
                });
            })
            .then(response => {
                fuse = new Fuse(response, fuse_options);
            });
        
        
            function reduce_key(array, prefix, suffix, delimeter = ', ') {
                if (array && array.length >= 1) {
                    let result = `${prefix}: `;
                    array.forEach(e => {
                        result += e + delimeter;
                    });
                    result = result.slice(0, -delimeter.length);
                    result += suffix;
                    return result;
                }
                else {
                    return '';
                }
            }
            
            $('.ui.search').search({ apiSettings: {
                responseAsync: (settings, callback) => {
                    if (fuse)
                    {
                        const search = fuse.search(settings.urlData.query);
                        const results = search.reduce((acc, cur) => {
                            const obj = {title: cur.title, url: cur.url};
                            obj.description = reduce_key(cur.series, 'סדרה', '. ')
                                + reduce_key(cur.categories, 'קטגוריות', '.');
                            acc.push(obj);
                            return acc;
                        }, []);
                        console.log(results);
                        callback({results: results, success: true});
                    }
                    else {
                        return {success: false};
                    }
                }
            }});</script>
    </body>
</html>
